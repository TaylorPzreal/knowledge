
Review
1. 2024-10-01 18:38

> [!Summary]
> 

## ä¸€ã€Introduction
### åè¯è§£é‡Š
åœ¨ç°ä»£ Web å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šå¬åˆ° CSRã€ISRã€SSR å’Œ SSG è¿™äº›æœ¯è¯­ï¼Œå®ƒä»¬ä»£è¡¨äº†ä¸åŒçš„**æ¸²æŸ“æ¨¡å¼**ï¼š
- **CSR (Client-Side Renderingï¼Œå®¢æˆ·ç«¯æ¸²æŸ“)**ï¼šå°†ç½‘é¡µçš„åˆå§‹çŠ¶æ€ä½œä¸º HTML ç»“æ„å‘é€åˆ°æµè§ˆå™¨ï¼Œç„¶åç”±æµè§ˆå™¨ä¸­çš„ JavaScript åŠ¨æ€åœ°è·å–æ•°æ®å¹¶æ¸²æŸ“é¡µé¢ã€‚
- **SSR (Server-Side Renderingï¼ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“)**ï¼šåœ¨æœåŠ¡å™¨ç«¯å°†æ•´ä¸ªé¡µé¢æ¸²æŸ“æˆå®Œæ•´çš„ HTMLï¼Œç„¶åå°†ç”Ÿæˆçš„ HTML å‘é€ç»™æµè§ˆå™¨ã€‚
- **SSG (Static Site Generationï¼Œé™æ€ç«™ç‚¹ç”Ÿæˆ)**ï¼šåœ¨æ„å»ºæ—¶å°†é¡µé¢æ¸²æŸ“æˆé™æ€ HTML æ–‡ä»¶ï¼Œéƒ¨ç½²åˆ°æœåŠ¡å™¨åç›´æ¥æä¾›ç»™ç”¨æˆ·ã€‚
- **ISR (Incremental Static Regenerationï¼Œå¢é‡é™æ€å†ç”Ÿ)**ï¼šç»“åˆäº† SSG å’Œ SSR çš„ä¼˜ç‚¹ï¼Œåœ¨æ„å»ºæ—¶ç”Ÿæˆé™æ€é¡µé¢ï¼Œå¹¶åœ¨è¿è¡Œæ—¶æ ¹æ®éœ€è¦æ›´æ–°éƒ¨åˆ†é¡µé¢ã€‚
- SPR (Serverless Pre-Renderingï¼Œæ— æœåŠ¡é¢„æ¸²æŸ“)ï¼šåœ¨ SSR æ¶æ„ä¸‹é€šè¿‡é¢„æ¸²æŸ“ä¸ç¼“å­˜èƒ½åŠ›ï¼Œå°†éƒ¨åˆ†é¡µé¢è½¬åŒ–ä¸ºé™æ€é¡µé¢ï¼Œä»¥é¿å…å…¶åœ¨æœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚çš„æ—¶å€™é¢‘ç¹è¢«æ¸²æŸ“çš„èƒ½åŠ›ï¼ŒåŒæ—¶ä¸€äº›æ¡†æ¶è¿˜æ”¯æŒè®¾ç½®é™æ€èµ„æºè¿‡æœŸæ—¶é—´ï¼Œä»¥ç¡®ä¿è¿™éƒ¨åˆ†â€œé™æ€é¡µé¢â€ä¹Ÿèƒ½æœ‰ä¸€å®šçš„å³æ—¶æ€§ã€‚
- NSR (Native Side Rendering) åœ¨ç”¨æˆ·å³å°†è®¿é—®é¡µé¢çš„ä¸Šçº§é¡µé¢é¢„å–é¡µé¢æ•°æ®ï¼Œç”±å®¢æˆ·ç«¯ç¼“å­˜ HTML ç»“æ„ï¼Œä»¥è¾¾åˆ°ç”¨æˆ·çœŸæ­£è®¿é—®æ—¶å¿«é€Ÿå“åº”çš„æ•ˆæœã€‚NSR è§äºå„ç§ç§»åŠ¨ç«¯ + Webview çš„ Hybrid åœºæ™¯ï¼Œæ˜¯éœ€è¦é¡µé¢ä¸å®¢æˆ·ç«¯ç ”å‘åä½œçš„ä¸€ç§ä¼˜åŒ–æ‰‹æ®µã€‚
- ESR (Edge Side Rendering) ESR å°±æ˜¯å°†æ¸²æŸ“å·¥ä½œäº¤ç»™è¾¹ç¼˜æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œå¸¸è§çš„å°±æ˜¯ CDN çš„è¾¹ç¼˜èŠ‚ç‚¹ã€‚è¿™ä¸ªæ–¹æ¡ˆä¸»æ‰“çš„æ˜¯è¾¹ç¼˜èŠ‚ç‚¹ç›¸æ¯”æ ¸å¿ƒæœåŠ¡å™¨ä¸ç”¨æˆ·çš„è·ç¦»ä¼˜åŠ¿ï¼Œåˆ©ç”¨äº† CDN åˆ†çº§ç¼“å­˜çš„æ¦‚å¿µï¼Œæ¸²æŸ“å’Œå†…å®¹å¡«å……ä¹Ÿå¯ä»¥æ˜¯åˆ†çº§è¿›è¡Œå¹¶ç¼“å­˜ä¸‹æ¥çš„ã€‚
- DPR (Distributed Persistent Rendering) <https://github.com/jamstack/jamstack.org/discussions/549>  


> [!Summary]- æ¸²æŸ“æ¨¡å¼
> è¿™é‡Œæ‰€è¯´çš„ âœŒğŸ» æ¸²æŸ“æ¨¡å¼ âœŒğŸ»ï¼ŒåŒ…æ‹¬ï¼š
> 
> - é¡µé¢ / åº”ç”¨åœ¨å¼€å‘å®Œæˆä¹‹åçš„äº§ç‰©ç¼–è¯‘æ–¹å¼ï¼›
> - éƒ¨ç½²ä¸Šçº¿ä¹‹åçš„æœåŠ¡å½¢æ€ï¼›
> - èµ„æºå­˜å‚¨ä¸åˆ†å‘çš„æ–¹å¼ï¼›
> - ç”¨æˆ·è®¿é—®æ—¶çš„å¯åŠ¨ä¸æ¸²æŸ“è¿‡ç¨‹ï¼›
> - è¿™å‡ æ–¹é¢ä¸åŒçš„å®ç°å’Œè§„èŒƒã€‚ 


#### ç‰¹å¾

| ç‰¹å¾   | CSR                    | SSR                 | SSG            | ISR             |
| ---- | ---------------------- | ------------------- | -------------- | --------------- |
| æ¸²æŸ“æ—¶æœº | æµè§ˆå™¨ç«¯                   | æœåŠ¡å™¨ç«¯                | æ„å»ºæ—¶            | æ„å»ºæ—¶ + è¿è¡Œæ—¶       |
| é¦–å±åŠ è½½ | è¾ƒæ…¢ï¼Œéœ€ç­‰å¾… JavaScript æ‰§è¡Œ   | è¾ƒå¿«ï¼Œç›´æ¥è¿”å› HTML        | éå¸¸å¿«ï¼Œç›´æ¥è¿”å› HTML  | éå¸¸å¿«ï¼Œç›´æ¥è¿”å› HTML   |
| SEO  | ä¸å‹å¥½ï¼Œæœç´¢å¼•æ“å¯èƒ½æ— æ³•æ­£ç¡®æŠ“å–       | å‹å¥½ï¼Œæœç´¢å¼•æ“å¯ä»¥å¾ˆå¥½åœ°æŠ“å–      | å‹å¥½ï¼Œæœç´¢å¼•æ“å¯ä»¥å¾ˆå¥½åœ°æŠ“å– | å‹å¥½ï¼Œæœç´¢å¼•æ“å¯ä»¥å¾ˆå¥½åœ°æŠ“å–  |
| åŠ¨æ€æ•°æ® | æ“…é•¿å¤„ç†                   | è¾ƒå¤æ‚ï¼Œéœ€è¦è€ƒè™‘æ•°æ®è·å–å’Œä¼ é€’     | ä¸æ“…é•¿å¤„ç†          | æ“…é•¿å¤„ç†            |
| å¼€å‘ä½“éªŒ | ç®€å•ï¼Œçƒ­æ›´æ–°æ–¹ä¾¿ã€‚å‰åç«¯åˆ†ç¦»ï¼ŒæœåŠ¡å™¨è´Ÿæ‹…è½»ã€‚ | å¤æ‚ï¼Œéœ€è¦è€ƒè™‘æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯çš„äº¤äº’ã€‚ | ç®€å•ï¼Œä½†éœ€è¦æå‰æ„å»º     | ä»‹äº SSR å’Œ SSG ä¹‹é—´ |

#### é€‚ç”¨åœºæ™¯
- **CSR**ï¼šé«˜åº¦äº¤äº’çš„å•é¡µåº”ç”¨ (SPA)
- **SSR**ï¼šé€‚ç”¨äºéœ€è¦è‰¯å¥½ SEO å’Œé¦–å±åŠ è½½æ€§èƒ½çš„åº”ç”¨ï¼Œå¦‚ç”µå•†ç½‘ç«™ç­‰ã€‚
- **SSG**ï¼šé€‚ç”¨äºé™æ€å†…å®¹ä¸ºä¸»çš„ç½‘ç«™æˆ–åšå®¢ï¼Œå¦‚æ–‡æ¡£ç«™ç‚¹ç­‰ã€‚
- **ISR**ï¼šé€‚ç”¨äºå†…å®¹ç»å¸¸æ›´æ–°ä½†ä¸éœ€è¦å®æ—¶æ€§çš„åº”ç”¨ï¼Œå¦‚è¥é”€æ´»åŠ¨é¡µé¢ç­‰ã€‚


## SSR
æœåŠ¡ç«¯æ¸²æŸ“ï¼Œå¯¹äºæµè§ˆå™¨ï¼ˆæˆ–è€… Hybridã€Webview ä¹‹ä¸‹çš„å®¿ä¸»ï¼‰ç¯å¢ƒçš„è·çŸ¥å’Œç›¸å…³æ“ä½œå°±ä¼šå—åˆ°å±€é™ï¼Œä¸€äº›æ“ä½œä¸å¾—ä¸å»¶è¿Ÿåˆ°å®¢æˆ·ç«¯æ¿€æ´»ä¹‹åæ‰å¾—ä»¥è¿›è¡Œã€‚

### React æä¾›çš„ SSR API
#### Server APIs
> The `react-dom/server` APIs let you render React components to HTML on the server. These APIs are only used on the server at the top level of your app to generate the initial HTML.
1. `renderToPipeableStream` *new*
2. `renderToStaticNodeStream` 
3. `renderToReadableStream` *new*
4. `renderToString`
5. `renderToStaticMarkup`
6. `renderToNodeStream` å·²åºŸå¼ƒ


> [!Summary]- Server APIs è¯¦ç»†ä»‹ç»
> 
> 1. `renderToString(element)`:
>     - ä¸»è¦ç”¨äºä¼ ç»Ÿçš„æœåŠ¡ç«¯æ¸²æŸ“
>     - å°†Reactç»„ä»¶æ¸²æŸ“ä¸ºHTMLå­—ç¬¦ä¸²
>     - ç”¨äºç”Ÿæˆåˆå§‹é¡µé¢å†…å®¹ï¼Œå¯¹SEOå’Œé¦–å±åŠ è½½å¾ˆæœ‰å¸®åŠ©
>     - è¿™æ˜¯Reactæ—©æœŸç‰ˆæœ¬å°±å­˜åœ¨çš„æ–¹æ³•ï¼Œåœ¨React 18ä¸­ä»ç„¶æ”¯æŒ
>     - æ€§èƒ½ç›¸å¯¹è¾ƒä½ï¼Œå› ä¸ºéœ€è¦å®Œå…¨æ¸²æŸ“æ•´ä¸ªç»„ä»¶æ ‘
> 2. `renderToStaticMarkup(element)`:
>     - ç±»ä¼¼äº`renderToString()`ï¼Œä½†ä¼šç”Ÿæˆæ›´å°‘çš„DOMå±æ€§
>     - ä¸»è¦ç”¨äºç”Ÿæˆé™æ€HTMLï¼Œä¸åŒ…å«Reactå†…éƒ¨ä½¿ç”¨çš„é¢å¤–å±æ€§
>     - é€‚åˆç”Ÿæˆä¸éœ€è¦äº¤äº’çš„é™æ€é¡µé¢
>     - ç”Ÿæˆçš„HTMLä½“ç§¯æ›´å°
> 3. `renderToPipeableStream(element)`:
>     - React 18å¼•å…¥çš„æ–°APIï¼Œä¸“ä¸ºNode.jsç¯å¢ƒè®¾è®¡
>     - æ”¯æŒæµå¼æœåŠ¡ç«¯æ¸²æŸ“
>     - å¯ä»¥åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­é€æ­¥å‘é€HTML
>     - æä¾›æ›´å¥½çš„æ€§èƒ½å’Œæ›´å¿«çš„é¦–å±åŠ è½½ä½“éªŒ
>     - æ”¯æŒä¸­æ–­å’Œæ¢å¤æ¸²æŸ“
> 4. `renderToReadableStream(element)`:
>     - React 18å¼•å…¥çš„æ–°API
>     - ä¸ºWeb Stream APIè®¾è®¡ï¼Œä¸»è¦ç”¨äºç°ä»£æµè§ˆå™¨å’Œè¾¹ç¼˜è¿è¡Œæ—¶ï¼ˆå¦‚Cloudflare Workersï¼‰
>     - è¿”å›ä¸€ä¸ªå¯è¯»çš„æµï¼ˆReadable Streamï¼‰
>     - æ”¯æŒSuspenseçš„æµå¼æ¸²æŸ“
>     - å¯ä»¥æ›´æ—©åœ°å¼€å§‹ä¼ è¾“HTMLï¼Œæé«˜æ€§èƒ½
>     - æ”¯æŒæ¸²æŸ“ä¸­æ–­å’Œé€æ­¥åŠ è½½
> 5. `renderToStaticNodeStream(element)`:
>     - ç±»ä¼¼äº`renderToStaticMarkup()`ï¼Œä½†è¿”å›ä¸€ä¸ªNode.jsæµ
>     - ç”¨äºç”Ÿæˆé™æ€HTMLæµ
>     - é€‚åˆéœ€è¦æµå¼ä¼ è¾“é™æ€HTMLçš„åœºæ™¯
>     - ç”Ÿæˆçš„HTMLä¸åŒ…å«Reactå†…éƒ¨å±æ€§

**ä¸»è¦åŒºåˆ«å’Œä½¿ç”¨åœºæ™¯**
- `renderToString()` æ˜¯ä¼ ç»Ÿçš„åŒæ­¥æ¸²æŸ“æ–¹æ³•ï¼Œå°† React tree æ¸²æŸ“æˆ string
-  `renderToStaticMarkup()` å’Œ `renderToStaticNodeStream()` é€‚ç”¨æ— äº¤äº’çš„åœºæ™¯æ¸²æŸ“
- `renderToPipeableStream()` é€‚ç”¨äºNode.jsç¯å¢ƒï¼Œå°† React tree æ¸²æŸ“æˆ Writable NodeJS Stream
- `renderToReadableStream()` é€‚ç”¨äºæ”¯æŒ [Web Stream API](https://developer.mozilla.org/zh-CN/docs/Web/API/Streams_API) çš„ç°ä»£æµè§ˆå™¨ï¼Œå°† React tree æ¸²æŸ“æˆ Readable Web Stream

`renderToString` ä¸è¶³
- æœåŠ¡ç«¯éœ€è¦å‡†å¤‡å¥½æ‰€æœ‰ç»„ä»¶çš„ HTML æ‰èƒ½è¿”å›ã€‚å¦‚æœæŸä¸ªç»„ä»¶éœ€è¦çš„æ•°æ®è€—æ—¶è¾ƒä¹…ï¼Œå°±ä¼šé˜»å¡æ•´ä¸ª HTML çš„ç”Ÿæˆã€‚
- Hydration æ˜¯ä¸€æ¬¡æ€§çš„ï¼Œç”¨æˆ·éœ€è¦ç­‰å¾…å®¢æˆ·ç«¯åŠ è½½æ‰€æœ‰ç»„ä»¶çš„ JavaScript å¹¶ Hydrated å®Œæˆåæ‰èƒ½å’Œä»»ä¸€ç»„ä»¶äº¤äº’ã€‚ï¼ˆæ¸²æŸ“é€»è¾‘å¤æ‚æ—¶ï¼Œé¡µé¢é¦–æ¬¡æ¸²æŸ“åˆ°å¯äº¤äº’ä¹‹é—´å¯èƒ½å­˜åœ¨è¾ƒé•¿çš„ä¸å¯äº¤äº’æ—¶é—´ï¼‰
- åœ¨ React SSR ä¸­ä¸æ”¯æŒå®¢æˆ·ç«¯æ¸²æŸ“å¸¸ç”¨çš„ä»£ç åˆ†å‰²ç»„åˆ`React.lazy`å’Œ`Suspense`ã€‚

`renderToNodeStream` React 18 åºŸå¼ƒ
åŸºæœ¬åŸç†æ˜¯ä»DOMæ ‘è‡ªé¡¶å‘ä¸‹å¼€å§‹æ¸²æŸ“ï¼Œå¹¶ä¸èƒ½ç­‰å¾…æŸä¸ªç»„ä»¶çš„æ•°æ®ï¼Œç„¶åå…ˆæ¸²æŸ“å…¶ä»–éƒ¨åˆ†çš„HTMLã€‚

æ–°çš„æµå¼æ¸²æŸ“APIï¼ˆ`renderToPipeableStream()`å’Œ`renderToReadableStream()`ï¼‰æ”¯æŒï¼š
- æ›´å¿«çš„é¦–å±åŠ è½½ï¼Œå‡å°‘ç™½å±æ—¶é—´
- æ”¯æŒ Suspense
- å¯ä»¥åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­é€æ­¥æ˜¾ç¤ºå†…å®¹ï¼Œå¯éšæ—¶ä¸­æ–­å’Œæ¢å¤æ¸²æŸ“

> - Streaming HTMLï¼šæœåŠ¡ç«¯å¯ä»¥åˆ†æ®µä¼ è¾“ HTML åˆ°æµè§ˆå™¨ï¼Œè€Œä¸æ˜¯åƒ React 18 ä»¥å‰ä¸€æ ·ï¼Œéœ€è¦ç­‰å¾…æœåŠ¡ç«¯æ¸²æŸ“å®Œæˆæ•´ä¸ªé¡µé¢åæ‰è¿”å›ç»™æµè§ˆå™¨ã€‚è¿™æ ·ï¼Œæµè§ˆå™¨å¯ä»¥æ›´å¿«çš„å¯åŠ¨ HTML çš„æ¸²æŸ“ï¼Œæé«˜ FPã€FCP ç­‰æ€§èƒ½æŒ‡æ ‡ã€‚
> - Selective Hydrationï¼šåœ¨æµè§ˆå™¨ç«¯ hydration é˜¶æ®µï¼Œå¯ä»¥åªå¯¹å·²ç»å®Œæˆæ¸²æŸ“çš„åŒºåŸŸåš hydrationï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ•´ä¸ªé¡µé¢æ¸²æŸ“å®Œæˆã€æ‰€æœ‰ç»„ä»¶çš„ JS Â bundle åŠ è½½å®Œæˆï¼Œæ‰èƒ½å¼€å§‹ hydrationã€‚è¿™æ ·å¯ä»¥æ›´æ—©çš„å¯¹å·²ç»å®Œæˆæ¸²æŸ“çš„åŒºåŸŸåšäº‹ä»¶ç»‘å®šï¼Œä»è€Œè®©é¡µé¢è·å¾—æ›´å¥½çš„å¯äº¤äº’æ€§ã€‚

| ç‰¹ç‚¹   | `renderToPipeableStream`                          | `renderToReadableStream` |
| ---- | ------------------------------------------------- | ------------------------ |
| æµçš„æ–¹å‘ | å¯å†™æµ                                               | å¯è¯»æµ                      |
| ä¸»è¦ç”¨é€” | è‡ªå®šä¹‰æ¸²æŸ“è¿‡ç¨‹ï¼Œå†™å…¥å“åº”                                      | é€æ­¥è¯»å–æ¸²æŸ“ç»“æœ                 |
| é€‚ç”¨åœºæ™¯ | ä¼ ç»Ÿçš„ Express/Koa Node.js æœåŠ¡å™¨ã€‚<br>æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œè‡ªå®šä¹‰ SSR é€»è¾‘ | ç°ä»£Webåº”ç”¨ï¼Œå®¢æˆ·ç«¯å¤„ç†æ¸²æŸ“ç»“æœï¼Œæ•°æ®å­˜å‚¨   |

> - **`renderToPipeableStream`:** é€‚åˆåœ¨æœåŠ¡å™¨ç«¯æ¸²æŸ“æ—¶ï¼Œéœ€è¦è‡ªå®šä¹‰æ¸²æŸ“è¿‡ç¨‹æˆ–å®ç°æµå¼æ¸²æŸ“çš„åœºæ™¯ã€‚
> - **`renderToReadableStream`:** é€‚åˆåœ¨å®¢æˆ·ç«¯éœ€è¦é€æ­¥å¤„ç†æ¸²æŸ“ç»“æœï¼Œæˆ–è€…éœ€è¦å°†æ¸²æŸ“ç»“æœå­˜å‚¨åˆ°å…¶ä»–åœ°æ–¹çš„åœºæ™¯ã€‚ç°ä»£æ— æœåŠ¡å™¨ (Serverless) æ¶æ„

#### `renderToPipeableStream` è¯¦è§£
##### ä»£ç ç¤ºä¾‹
```jsx
const { pipe, abort } = ReactDOMServer.renderToPipeableStream(
    <App />,
    {
      bootstrapScriptContent: `window.__MOCK_DATA__ = ${JSON.stringify({ x: 1, y: 2 })}`,
      bootstrapScripts: ["/main.js"],
      identifierPrefix: '', // idprefix
      onShellReady() { },
      onShellError() {
        res.statusCode = 500;
        res.send("<!doctype html><p>Loading...</p>");
      },
      onAllReady() {
        res.statusCode = 200;
        res.setHeader("Content-type", "text/html");
        pipe(res);
      },
      onError() { },
    }
);
```

```jsx
ReactDOM.hydrateRoot(
  document,
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
```


##### å ä½ç¬¦
ä¸åŒçš„ id å‰ç¼€ä»£è¡¨ä¸åŒä½œç”¨çš„å…ƒç´ ï¼š
- **Placeholder**ï¼š`P:` å ä½å—
- **Segment**ï¼š`S:` è¦æ’å…¥çš„æœ‰æ•ˆç‰‡æ®µï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„ã€å¯ä»¥ç‹¬ç«‹æ¸²æŸ“çš„ç‰‡æ®µ
- **Boundary**ï¼š`B:` Suspense ç»„ä»¶è¾¹ç•Œ

identifierPrefix -> idPrefix -> `${idPrefix}P:${treeId}`

- **Id**ï¼š`R:` å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºåŒºåˆ†ä¸åŒçš„ Placeholder, Segment, Boundary

ä¸åŒçš„æ³¨é‡Šæ ‡æ³¨å¼€å¤´ä»£è¡¨ä¸åŒ Suspense è¾¹ç•Œ ï¼ˆSuspense boundariesï¼‰çŠ¶æ€çš„å—ï¼š

> ä¸ºäº†ä¸å½±å“ CSS é€‰æ‹©å™¨å’Œå±•ç¤ºæ•ˆæœï¼ŒSuspense Boundary ä¸æ˜¯ä¸€ä¸ªå…·ä½“ç‰‡æ®µæˆ–è€…è‡ªå®šä¹‰æ ‡ç­¾

- **Completed**ï¼ˆå·²å®Œæˆï¼‰ï¼š`<!--$-->`
- **Pending**ï¼ˆç­‰å¾…ä¸­ï¼‰ï¼š`<!--$?-->`
- **ClientRendered**ï¼ˆå®¢æˆ·ç«¯å·²æ¸²æŸ“ï¼‰ï¼š`<!--$!-->`

æ ‡æ³¨ç»“æŸçš„æ³¨é‡Šåˆ™ç»Ÿä¸€ä¸º`<!--/$-->`


##### è¯¦è§£
NodeJS Writable Stream
ä¸€èˆ¬æ¥è¯´ï¼Œæµå¼æ¸²æŸ“å°±æ˜¯æŠŠ HTML åˆ†å—é€šè¿‡ç½‘ç»œä¼ è¾“ï¼Œç„¶åå®¢æˆ·ç«¯æ”¶åˆ°åˆ†å—åé€æ­¥æ¸²æŸ“ï¼Œæå‡é¡µé¢æ‰“å¼€æ—¶çš„ç”¨æˆ·ä½“éªŒã€‚é€šå¸¸æ˜¯åˆ©ç”¨ `HTTP/1.1` ä¸­çš„åˆ†å—ä¼ è¾“ç¼–ç ï¼ˆChunked transfer encodingï¼‰æœºåˆ¶ã€‚

```js
const http = require("http");
const url = require("url");

const sleep = (ms) => {
  return new Promise((resolve) => {
    setTimeout(resolve, ms);
  });
};

const server = http.createServer(async (req, res) => {
  const { pathname } = url.parse(req.url);
  if (pathname === "/") {
    res.statusCode = 200;
    res.setHeader("Content-Type", "text/html");
    res.setHeader("Transfer-Encoding", "chunked");
    res.write("<html><body><div>First segment</div>");
    // æ‰‹åŠ¨è®¾ç½®å»¶æ—¶ï¼Œè®©åˆ†æ®µæ˜¾ç¤ºçš„æ•ˆæœæ›´åŠ æ˜æ˜¾
    await sleep(2000);
    res.write("<div>Second segment</div></body></html>");
    res.end();
    return;
  }

  res.writeHead(200, { "Content-Type": "text/plain" });
  res.end("okay");
});

server.listen(8080);
```

#### `renderToReadableStream` è¯¦è§£


#### NextJS å¦‚ä½•æ”¯æŒçš„ SSR


### RSC (React Server Component)


### SSR ç¨³å®šæ€§ä¿éšœ
1. APIä¸ç¨³å®šï¼šæ— è§£
2. SSRæœåŠ¡ä¸ç¨³å®š

SSRæœåŠ¡ä¸ç¨³å®š
1. å‘ä¸‹å…œåº•CSR
2. SSR+Serverlessï¼šæ ¹æ®QPSã€CPUã€å†…å­˜ä½¿ç”¨ç‡ï¼Œè‡ªåŠ¨ç§’çº§æ‰©ç¼©å®¹


## SSG


## ISR



## Reference
Server React DOM APIs <https://react.dev/reference/react-dom/server> 
Rendering on the Web <https://web.dev/articles/rendering-on-the-web> 
é™¤äº† CSRã€SSRï¼Œè¿˜æœ‰å“ªäº”ç§æ¸²æŸ“æ¨¡å¼ï¼Ÿ <https://mp.weixin.qq.com/s/JSbOdD6AmjgS_gmqeGnYmg>
[Github ssr](https://github.com/zhangyuang/ssr/tree/dev) 